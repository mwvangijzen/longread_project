---
title: "R Notebook"
output: html_notebook
---

```{r}
library(rtracklayer)

annotated_gtf <- rtracklayer::import("/hpc/pmc_vanheesch/projects/Damon/Neuroblastoma_neoantigens/RNA_nbl_transcriptome_assembly/analysis/gffcompare/NBL_full_transcriptome/NBL_full_transcriptome_gffcompare_new.annotated.gtf")

combined_gtf <- rtracklayer::import("/hpc/pmc_vanheesch/projects/Damon/Neuroblastoma_neoantigens/RNA_nbl_transcriptome_assembly/analysis/gffcompare/NBL_full_transcriptome/NBL_full_transcriptome_matching.combined.gtf")

combined_gtf_df <- data.frame(combined_gtf)
```

```{r}
library(dplyr)

# Select only transcripts from the combined GTF that fully match the transcripts in the reference.
# In this case, the 'reference' GTF is already our novel annotated merged stringtie GTF, so we 
# don't need to look for other class codes.

# Assuming your data frame is named df
selected_transcripts <- combined_gtf_df %>%
  filter(type == 'transcript', class_code == '=')

selected_exons <- combined_gtf_df %>%
  filter(type == 'exon', transcript_id %in% selected_transcripts$transcript_id)

# Combining the selected transcripts and exons into one dataframe
selected_data <- bind_rows(selected_transcripts, selected_exons)

# Sorting by transcript_id and start position to organize the data
combined_gtf_df_filtered <- selected_data %>%
  arrange(transcript_id, start)

```


```{r}
library(ggplot2)
library(dplyr)

# First, convert num_samples to numeric if it's not already
combined_gtf_df_filtered <- combined_gtf_df_filtered %>%
  mutate(num_samples = as.numeric(num_samples))

# Now, get the count of transcripts per number of samples
transcript_counts <- combined_gtf_df_filtered %>%
  filter(type == 'transcript') %>%
  group_by(num_samples) %>%
  summarise(count = n())

# Now create the bar plot
ggplot(transcript_counts, aes(x = num_samples, y = count)) +
  geom_bar(stat = 'identity') +
  labs(
    title = "Distribution of Transcripts by Number of Samples",
    x = "Number of Samples",
    y = "Count of Transcripts"
  ) +
  theme_minimal()

```

```{r}
num_samples <- combined_gtf_df_filtered[c("cmp_ref", "num_samples")]
colnames(num_samples) <- c("transcript_id", "num_samples")

# Get the number of samples containing each transcript from the combined GTF
num_samples <- subset(combined_gtf_df, type == "transcript")[c("cmp_ref", "num_samples", "class_code")]
colnames(num_samples) <- c("transcript_id", "num_samples", "class_code")

# Assuming your data frame is named combined_gtf_df
num_samples_new <- combined_gtf_df %>%
  filter(type == 'transcript') %>%
  select(cmp_ref, num_samples, class_code) %>%
  rename(transcript_id = cmp_ref) %>%
  arrange(desc(class_code == '=')) %>%
  group_by(transcript_id) %>%
  slice(1) %>%
  ungroup()

annotated_gtf_df_new <- 
  left_join(annotated_gtf_df, num_samples_new, by = 'transcript_id')

```

```{r}
library(dplyr)

# Step 1: Create a mapping table from the transcript rows
transcript_mapping <- annotated_gtf_df_new %>%
  filter(type == 'transcript') %>%
  mutate(
    new_transcript_id = ifelse(!is.na(cmp_ref) & !is.na(ref_gene_id), cmp_ref, transcript_id),
    new_gene_id = ifelse(!is.na(ref_gene_id), ref_gene_id, gene_id)
  ) %>%
  select(transcript_id, new_transcript_id, new_gene_id)

# Step 2: Join the mapping table with the original data frame and update the transcript_id and gene_id
updated_gtf <- annotated_gtf_df_new %>%
  left_join(transcript_mapping, by = "transcript_id") %>%
  mutate(
    transcript_id = coalesce(new_transcript_id, transcript_id),
    gene_id = coalesce(new_gene_id, gene_id)
  ) %>%
  select(-new_transcript_id, -new_gene_id)  # Remove the extra columns from the mapping table


```



```{r}
combined_gtf_df_filtered <- subset(combined_gtf_df, class_code == "=")

combined_gtf_filtered <- GRanges(combined_gtf_df_filtered)
```

